name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allows manual triggering from GitHub Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e  # Exit on error
            
            DEPLOY_DIR="/var/www/rolstonheatingandcooling.com"
            
            echo "üöÄ Starting deployment..."
            
            # Navigate to deploy directory
            cd "$DEPLOY_DIR" || {
                echo "‚ùå Error: Directory $DEPLOY_DIR does not exist"
                exit 1
            }
            
            # Git operations handled by GitHub Actions - ensure we're on latest
            git fetch origin master
            git reset --hard origin/master
            
            # Run database migrations
            echo "üóÑÔ∏è  Running database migrations..."
            if [ -f "$DEPLOY_DIR/.env" ]; then
                # Source the .env file to get database variables
                export $(grep -v '^#' "$DEPLOY_DIR/.env" | sed 's/#.*//' | sed 's/[[:space:]]*$//' | grep -v '^$$' | xargs)
                
                # Build DATABASE_URL from individual variables
                if [ ! -z "$DB_HOST" ] && [ ! -z "$DB_USER" ] && [ ! -z "$DB_PASSWORD" ] && [ ! -z "$DB_NAME" ]; then
                    DB_PORT=${DB_PORT:-5432}
                    DB_SSLMODE=${DB_SSLMODE:-require}
                    
                    # Build PostgreSQL connection URL
                    DB_URL="postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=${DB_SSLMODE}"
                    
                    # Check if migrations directory exists and has files
                    if [ -d "$DEPLOY_DIR/backend/migrations" ] && [ -n "$(ls -A $DEPLOY_DIR/backend/migrations/*.sql 2>/dev/null)" ]; then
                        # Use migrate tool via Docker if available
                        docker run --rm \
                            -v "$DEPLOY_DIR/backend/migrations:/migrations" \
                            --network host \
                            migrate/migrate \
                            -path /migrations \
                            -database "$DB_URL" \
                            up || {
                            echo "‚ö†Ô∏è  Warning: Migration failed or no migrations to run"
                        }
                        echo "‚úÖ Migrations complete"
                    else
                        echo "‚ÑπÔ∏è  No migration files found, skipping migrations"
                    fi
                else
                    echo "‚ö†Ô∏è  Warning: Database variables (DB_HOST, DB_USER, DB_PASSWORD, DB_NAME) not found in .env, skipping migrations"
                fi
            else
                echo "‚ö†Ô∏è  Warning: .env file not found, skipping migrations"
            fi
            
            # Restart Docker containers
            echo "üê≥ Restarting Docker containers..."
            cd "$DEPLOY_DIR" || {
                echo "‚ùå Error: Failed to change to deploy directory"
                exit 1
            }
            
            # Verify backend directory exists
            if [ ! -d "backend" ]; then
                echo "‚ùå Error: backend directory not found in $DEPLOY_DIR"
                ls -la
                exit 1
            fi
            
            echo "üì¶ Building Docker containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            # Build from the root directory explicitly
            docker-compose -f docker-compose.prod.yml build --no-cache --progress=plain 2>&1 || {
                echo "‚ùå Error: Failed to build Docker containers"
                echo "Current directory: $(pwd)"
                echo "Backend directory exists: $([ -d backend ] && echo 'yes' || echo 'no')"
                exit 1
            }
            
            docker-compose -f docker-compose.prod.yml up -d || {
                echo "‚ùå Error: Failed to start Docker containers"
                exit 1
            }
            echo "‚úÖ Docker containers restarted"
            
            echo "üéâ Deployment complete!"

# GitHub Secrets Required:
# DEPLOY_HOST: Your server IP address
# DEPLOY_USER: root (or your deploy user)
# DEPLOY_SSH_KEY: Your private SSH key (the private key that matches your public key on the server)

